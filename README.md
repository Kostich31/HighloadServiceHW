# Telegram
# 1. Тема и целевая аудитория
### Тема
Мессенджер **Telegram** - кроссплатформенная система мгновенного обмена сообщениями, позволяющая обмениваться текстовыми, голосовыми и видеосообщениями, стикерами и фотографиями, файлами многих форматов.
### Функционал MVP
- регистрация по номеру телефона
- отправка текстовых сообщений
- отправка голосовых сообщений
- отправка фотографий
- список чатов
- история сообщений
### Целевая аудитория
Ниже представлена статистика исследования аудитории Telegram. В опросе приняли участие жители из более чем 70 стран.
Возраст целевой аудитории варьируется в диапазоне от 18 до 64 лет [[1]](https://tgstat.ru/research-2021)
Возрастная группа | Процентное соотношение
------------ | -------------
до 17 лет | 7,7%
18-24 года| 21,9% 
25-34 года| 30,6% 
35-44 года| 21,3% 
45-64 года| 18,5% 

Размер целевой аудитории: 550 млн. пользователей в месяц, 55 млн. пользователей в день. [[2]](https://www.demandsage.com/telegram-statistics/)

Общемировая география пользователей [[3]](https://www.businessofapps.com/data/telegram-statistics/):  
Регион           | Процентное соотношение
---------------- | -------------
Азия             | 38%
Европа           | 27% 
Латинская Америка| 21% 
страны MENA      | 8% 

География русскоязычных пользователей:
Страна       | Процентное соотношение
-------------| -------------
Россия       | 60%
Беларусь     | 17% 
Украина      | 13% 

# 2. Расчёт нагрузки

### Продуктовые метрики
Ежемесячная аудитория Telegram: 550 млн. пользователей.

Ежедневная аудитория Telegram: 55 млн. пользователей.

Количество отправленных сообщений в день: 15 миллиардов.[[4]](https://siteefy.com/telegram-statistics/)

Количество регистраций в день: 1.5 млн.

Средняя длительность сессии: 6 минут.

Количество заходов в день: 24 [[5]](https://www.tadviser.ru/index.php/Статья:Мессенджеры_(Instant_Messenger,_IM)#:~:text=Как%20выяснилось%2C%20в%20среднем%20пользователь,идут%20Viber%2C%20Telegram%20и%20Skype.)

#### Хранилище данных для пользователя
Посчитаем количество сообщений в день на одного пользователя : 15 млрд. / 55 млн. = 272

Пусть:
  - Из 272 сообщений 5 будут голосовыми и 5 будут фотографиями.
  - Средняя длина одного сообщения равна 80 символам в кодировки UTF-8, где 1 символ равен 1 байту. [[6]](https://cyberleninka.ru/article/n/poliformatnyy-messendzher-kak-zhanr-2-0-na-primere-messendzhera-mgnovennyh-soobscheniy-telegram/viewer)
  - Средняя длина записи одного голосового сообщения равна 60 секундам, битрейт равен 128 kbps, тогда размер будет равен 960 кБ.
  - Средний размер одной фотографии равен 0.25 Мб.
  - Сообщения хранятся 5 лет.
  - Среднее количество чатов у одного пользователя равно 15
  - Количество единовременно подгружаемых сообщений в диалоге равно 10
  - Среднее количество людей, с которыми пользователь общается в день равно 8

Чат в списке чатов состоит из аватарки чата(0.25 Мб), последнего сообщения(30 символов), названия чата(20 символов). 
Тогда размер одного чата равен: 256 Кб + 30 * 0.03(кБ) + 20 * 0.02(кБ) = 257.3 кБ

Тогда общий объем **сообщений**, отправляемых в день, на одного пользователя равен: 262 * 0.02(кБ) + 5 * 960(кБ) + 5 * 256(кБ) = 6086 кБ

Средний размер **профиля** пользователя составляет 1 Мб (аватарка + данные о пользователе(номер телефона, уникальный идентификатор, имя).

Суммарный объем данных на одного пользователя за 5 лет: 9920(кБ) * 365 * 5 + 1024(кБ) = 18.1 гБ

#### Сетевой трафик
При расчете сетевого трафика не будем учитывать запросы, связанные с регистрацией пользователей, так как они не создают ощутимую нагрузку на наш сервис.
Основная нагрузка приходится на отправку сообщений, загрузку списка чатов и историю сообщений.

##### Предварительные расчеты:
Посчитаем объем трафика для списка чатов на одного человека с учетом количества заходов в сутки: 24 * 15 * 257.3 кБ = 92 628 кБ
Посчитаем объем трафика для истории сообщений на одного человека с учетом  количества единовременно подгружаемых сообщений в диалоге, среднего количества людей, с которыми общается пользователь в день: 8 * 10 * 0.02 (кБ) = 1.6 кБ

Рассмотрим трафик по видам активностей:
    Тип          | Отправка (дневная аудитория 55 млн) | Отправка ГБ/сек |        
   ------------- |--------------------------------------|-------------------|
   Текстовое     | 262 * 55 млн. * 0. 02 кБ             | 0.0032            |
   Голосовое     | 5 * 55 млн. * 960 кБ                 | 2.92              | 
   Фотография    | 5 * 55 млн. * 1024 кБ                | 3.11              |
   Список чатов  | 92 628 кБ * 55 млн.                  | 56.23             |
   История сообщений  | 1.6 кБ * 55 млн.                | 0.001             |
   Итого  |                                             | 62.2642           |


#### RPS
 
 - Отправка сообщения: 55 млн * 272 / 86400 = 173 148 RPS
 - Регистрация: 1.5 млн / 86400 = 17 RPS
 - Авторизация: 55 млн. / 86400 = 637 RPS
 - Получение списка чатов: 55 млн. * 24 / 86400 = 15 278 RPS
 - Получение истории сообщений: 55 млн. * 8 / 86400 = 5 093 RPS

   Действие                            | RPS
   ------------------------------------| ---
   Отправка сообщения                  | 173 148
   Регистрация                         | 17
   Авторизация                         | 637
   Получение списка чатов              | 15 278
   История сообщений                   | 5 093
   **Итого**                           | 194 173
#### Пиковая нагрузка

**Пиковая нагрузка для RPS**

Пусть в момент пиковой нагрузки RPS в 1.5 раза выше среднего значения (291260), а минимальная нагрузка в 2 раза меньше среднего значения (97860), тогда можно построить график по 4-м точкам (0; 97860) (12; 291260) (17; 194173)  (24; 100000):

![image](https://user-images.githubusercontent.com/29610387/198867026-acd425a3-a109-4482-8ff7-56fa378fd743.png)

**Пиковая нагрузка для сетевого трафика**

Если учесть, что RPS повысилось в 1.5 раза выше среднего, то объем сетевого трафика также увеличится в 1.5 раза.
Итоговая таблица с значениями пиковых нагрузок с добавлением коэффициента запаса:
    Тип                 | Пиковое значение|Пиковое значение с коэффициентом запаса 2         |        
   ---------------------|-----------------|--------------------------------------------------|
   RPS                  | 291 260         | 582 520                                          |
   Сетевой трафик(ГБ/c) | 93,3963         | 186,7926                                         | 
   
   
# 3. Логическая схема БД
![image](https://user-images.githubusercontent.com/29610387/198966544-e7899668-6664-401d-a89a-423ace9712ba.png)

# 4. Физическая схема БД

Для хранения информации о сессиях (таблица Session) пользователей будем использовать базу данных Redis потому, что она осуществляет хранение данных in-memory, имеет поддержку неблокирующей репликации master-slave и возможность организации кластера Redis cluster.

Для хранения чатов (таблица Chat), пользователей (таблица User) и сообщений (таблица Message) будем использовать базу данных MongoDB. Эта база данных легко масштабируется и предоставляет быстрый доступ к данным. У нее нет схем таблиц, что, в дальнейшем, упрощает изменение набора данных. Для увеличения отказоустойчивости будем использовать репликацю, которая поддерживается в MongoDB, master - slave.

Для хранения файлов будем использовать amazom S3 хранилище, а в базе будем хранить лишь ссылку, которую и будем отдавать клиенту.

# 5. Выбор технологий

| Технология | Область применения                        | Мотивационная часть                                          |
| ---------- | ----------------------------------------- | ------------------------------------------------------------ |
| TypeScript | Frontend.                                 | Типизация                                                |
| React      | Библиотека Frontend                       | Библиотека с компонентным подходом для создания пользовательского интерфейса, имеет свою реализацию Virtual DOM, повыщающую производительность приложения. Благодаря высокой популярности библиотека найти разработчиков будет относительно легко.  |
| Nginx      | Web-server<br />Reverse proxy             | Быстрый веб-сервер, простая настройка                        |
| Go     |                   Backend                 | Быстро писать Backend, дает достаточно хорошую производительность на больших нагрузках. Имеет множество готовых библиотек, упрощающих жизнь разработчиков и ускоряющих процесс реализации, а также имеет встроенные горутины и каналы, которые позволяют эффективно распараллеливать производимые вычисления.
| Redis      | Сессии                                    | In-memory БД позволяет обеспечить высокую скорость на чтение и запись |
| MongoDB    | Хранение пользователей и списка его чатов | Отлично подходит для  большого объема данных, поддерживает репликацю. Хорошо использовать, когда в схеме БД мало связей. |
| Amazon S3  | Файловое хранилище                        | Высокая надежность, доступность, производительностью и безопасность |


# 8. Ссылки на источники
1. https://tgstat.ru/research-2021
2. https://www.demandsage.com/telegram-statistics/
3. https://www.businessofapps.com/data/telegram-statistics/
4. https://siteefy.com/telegram-statistics/
5. https://www.tadviser.ru/index.php/Статья:Мессенджеры_(Instant_Messenger,_IM)#:~:text=Как%20выяснилось%2C%20в%20среднем%20пользователь,идут%20Viber%2C%20Telegram%20и%20Skype.
6. https://cyberleninka.ru/article/n/poliformatnyy-messendzher-kak-zhanr-2-0-na-primere-messendzhera-mgnovennyh-soobscheniy-telegram/viewer
