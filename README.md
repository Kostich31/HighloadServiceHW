# Telegram
# 1. Тема и целевая аудитория
### Тема
Мессенджер **Telegram** - кроссплатформенная система мгновенного обмена сообщениями, позволяющая обмениваться текстовыми, голосовыми и видеосообщениями, стикерами и фотографиями, файлами многих форматов.
### Функционал MVP
- регистрация по номеру телефона
- отправка текстовых сообщений
- отправка голосовых сообщений
- отправка фотографий
- список чатов
- история сообщений
### Целевая аудитория
Ниже представлена статистика исследования аудитории Telegram. В опросе приняли участие жители из более чем 70 стран.
Возраст целевой аудитории варьируется в диапазоне от 18 до 64 лет [[1]](https://tgstat.ru/research-2021)
Возрастная группа | Процентное соотношение
------------ | -------------
до 17 лет | 7,7%
18-24 года| 21,9% 
25-34 года| 30,6% 
35-44 года| 21,3% 
45-64 года| 18,5% 

Размер целевой аудитории: 550 млн. пользователей в месяц, 55 млн. пользователей в день. [[2]](https://www.demandsage.com/telegram-statistics/)

Общемировая география пользователей [[3]](https://www.businessofapps.com/data/telegram-statistics/):  
Регион           | Процентное соотношение
---------------- | -------------
Азия             | 38%
Европа           | 27% 
Латинская Америка| 21% 
страны MENA      | 8% 

География русскоязычных пользователей:
Страна       | Процентное соотношение
-------------| -------------
Россия       | 60%
Беларусь     | 17% 
Украина      | 13% 

# 2. Расчёт нагрузки

### Продуктовые метрики
Ежемесячная аудитория Telegram: 550 млн. пользователей.

Ежедневная аудитория Telegram: 55 млн. пользователей.

Исходя из исследования [[4]](https://siteefy.com/telegram-statistics/):

Количество отправленных сообщений в день: 15 миллиардов

Количество регистраций в день: 1.5 млн.

Средняя длительность сессии: 6 минут.

Исходя из исследования [[5]](https://www.tadviser.ru/index.php/Статья:Мессенджеры_(Instant_Messenger,_IM)#:~:text=Как%20выяснилось%2C%20в%20среднем%20пользователь,идут%20Viber%2C%20Telegram%20и%20Skype.):

Количество заходов в день: 24 

#### Хранилище данных для пользователя
Посчитаем количество сообщений в день на одного пользователя : 15 млрд. / 55 млн. = 272

Пусть:
  - Из 272 сообщений 5 будут голосовыми и 5 будут фотографиями.
  - Средняя длина одного сообщения равна 60 символам в кодировки UTF-8, где 1 символ равен 1 байту. [[6]](https://cyberleninka.ru/article/n/poliformatnyy-messendzher-kak-zhanr-2-0-na-primere-messendzhera-mgnovennyh-soobscheniy-telegram/viewer)
  - Средняя длина записи одного голосового сообщения равна 60 секундам, битрейт равен 128 kbps, тогда размер будет равен 480 кБ.
  - Средний размер одной фотографии из сообщений равен 256 кБ.
  - Сообщения хранятся 5 лет.
  - Среднее количество чатов у одного пользователя равно 15
  - Количество единовременно подгружаемых сообщений в диалоге равно 10
  - Среднее количество людей, с которыми пользователь общается в день равно 8
  - Размер сообщения в превью чата равен 30 символам
  - Название чата равно 20 символам

Чат в списке чатов состоит из аватарки чата(100 кБ), последнего сообщения (превью), названия чата.
Тогда размер одного чата равен: 100 кБ + 30 * 0.03(кБ) + 20 * 0.02(кБ) = 101.3 кБ

Тогда общий объем **сообщений**, отправляемых в день, на одного пользователя равен: 262 * 0.06 (кБ) + 5 * 480 (кБ) + 5 * 100 (кБ) = 2916 кБ

Средний размер **профиля** пользователя составляет 100 кБ (аватарка + данные о пользователе(номер телефона, уникальный идентификатор, имя).

Суммарный объем данных на одного пользователя за 5 лет: 2916(кБ) * 365 * 5 + 256 (кБ) = 5.1 гБ

#### Сетевой трафик
При расчете сетевого трафика не будем учитывать запросы, связанные с регистрацией пользователей, так как они не создают ощутимую нагрузку на наш сервис.
Основная нагрузка приходится на отправку сообщений, загрузку списка чатов и историю сообщений.

##### Предварительные расчеты:
Посчитаем объем трафика для списка чатов на одного человека с учетом количества заходов в сутки: 24 * 15 * 101.3 кБ = 36 468 кБ
Посчитаем объем трафика для истории сообщений на одного человека с учетом  количества единовременно подгружаемых сообщений в диалоге, среднего количества людей, с которыми общается пользователь в день: 8 * 10 * 0.06 (кБ) = 4.8 кБ

Рассмотрим трафик по видам активностей:
    Тип          | Отправка (дневная аудитория 55 млн) | Отправка Гб/сек |        
   ------------- |--------------------------------------|-------------------|
   Текстовое     | 262 * 55 млн. * 0. 06 кБ             | 0.076            |
   Голосовое     | 5 * 55 млн. * 480 кБ                 | 11.6              | 
   Фотография    | 5 * 55 млн. * 256 кБ                | 6.2              |
   Список чатов  | 36 468 кБ * 55 млн.                  | 177.1|
   История сообщений  | 4.8 кБ * 55 млн.                | 0.023             |
   Итого  |                                             | 195           |


#### RPS
 
 - Отправка сообщения: 55 млн * 272 / 86400 = 173 148 RPS
 - Регистрация: 1.5 млн / 86400 = 17 RPS
 - Авторизация: 55 млн. / 86400 = 637 RPS
 - Получение списка чатов: 55 млн. * 24 / 86400 = 15 278 RPS
 - Получение истории сообщений: 55 млн. * 8 / 86400 = 5 093 RPS

   Действие                            | RPS
   ------------------------------------| ---
   Отправка сообщения                  | 173 148
   Регистрация                         | 17
   Авторизация                         | 637
   Получение списка чатов              | 15 278
   История сообщений                   | 5 093
   **Итого**                           | 194 173
#### Пиковая нагрузка

**Пиковая нагрузка для RPS**

Возьмем за основу расчетов пиковой нагрузки метрики реального сервиса, предоставленные моим ментором.
![image](https://user-images.githubusercontent.com/29610387/201480449-f836807a-7ee7-493f-815e-3a7595c1b40e.png)

На данном графике видно, что максимальное значение RPS примерно равно 9200, минимальное значение равно примерно 1400, а среднее значение примерно 5700.

Если использовать соотношения значений из предоставленного графика для расчета пиковой нагрузки в нашем сервисе, то получаем:

Средний RPS равен 194 173, тогда пиковый RPS равен 194 173 * 1.6 = 310 677, минимальный RPS равен 194 173 * 0.24 = 46 601

Воспользуемся сервисом https://yotx.ru/ для построения графика по 4-м точкам. (0; 46 601), (10; 310 677), (21; 194 173), (24; 46 601).

![yotx ru](https://user-images.githubusercontent.com/29610387/201481087-87c11ca2-7915-404c-b8f0-d81eea4195be.png)

**Пиковая нагрузка для сетевого трафика**

Если учесть, что RPS повысилось в 1.6 раз выше среднего, то объем сетевого трафика также увеличится в 1.6 раз.
Итоговая таблица с значениями пиковых нагрузок с добавлением коэффициента запаса:
    Тип                 | Пиковое значение|Пиковое значение с коэффициентом запаса 2         |        
   ---------------------|-----------------|--------------------------------------------------|
   RPS                  | 310 677         | 621 354                                          |
   Сетевой трафик(ГБ/c) | 312             | 624                                              | 
   
   
# 3. Логическая схема БД
![image](https://user-images.githubusercontent.com/29610387/198966544-e7899668-6664-401d-a89a-423ace9712ba.png)

# 4. Физическая схема БД

Для хранения информации о сессиях (таблица Session) пользователей будем использовать базу данных Redis потому, что она осуществляет хранение данных in-memory, имеет поддержку неблокирующей репликации master-slave и возможность организации кластера Redis cluster.

Для хранения чатов (таблица Chat), пользователей (таблица User) и сообщений (таблица Message) будем использовать базу данных MongoDB. Эта база данных легко масштабируется и предоставляет быстрый доступ к данным. У нее нет схем таблиц, что, в дальнейшем, упрощает изменение набора данных. Для увеличения отказоустойчивости будем использовать репликацю, которая поддерживается в MongoDB, master - slave.

Для хранения файлов будем использовать amazom S3 хранилище, а в базе будем хранить лишь ссылку, которую и будем отдавать клиенту.

# 5. Выбор технологий

| Технология | Область применения                        | Мотивационная часть                                          |
| ---------- | ----------------------------------------- | ------------------------------------------------------------ |
| TypeScript | Frontend.                                 | Типизация                                                |
| React      | Библиотека Frontend                       | Библиотека с компонентным подходом для создания пользовательского интерфейса, имеет свою реализацию Virtual DOM, повыщающую производительность приложения. Благодаря высокой популярности библиотека найти разработчиков будет относительно легко.  |
| Nginx      | Web-server<br />Reverse proxy             | Быстрый веб-сервер, простая настройка                        |
| Go     |                   Backend                 | Быстро писать Backend, дает достаточно хорошую производительность на больших нагрузках. Имеет множество готовых библиотек, упрощающих жизнь разработчиков и ускоряющих процесс реализации, а также имеет встроенные горутины и каналы, которые позволяют эффективно распараллеливать производимые вычисления.
| Redis      | Сессии                                    | In-memory БД позволяет обеспечить высокую скорость на чтение и запись |
| MongoDB    | Хранение пользователей и списка его чатов | Отлично подходит для  большого объема данных, поддерживает репликацю. Хорошо использовать, когда в схеме БД мало связей. |
| Amazon S3  | Файловое хранилище                        | Высокая надежность, доступность, производительностью и безопасность |

# 6. Выбор технологий
Балансировка: DNS и L7-балансировка Nginx.

Chat service - основной сервис, обрабатывает создание чатов, подгрузку списка чатов.

Auth service - сервис авторизации, обрабатывает запросы, связанные с авторизацией пользователей.

Message serice - сервис сообщений.

<img width="761" alt="Снимок экрана 2022-11-06 в 17 39 02" src="https://user-images.githubusercontent.com/29610387/200177104-c51ca463-9787-411e-b292-a91500bc9514.png">

# 8. Ссылки на источники
1. https://tgstat.ru/research-2021
2. https://www.demandsage.com/telegram-statistics/
3. https://www.businessofapps.com/data/telegram-statistics/
4. https://siteefy.com/telegram-statistics/
5. https://www.tadviser.ru/index.php/Статья:Мессенджеры_(Instant_Messenger,_IM)#:~:text=Как%20выяснилось%2C%20в%20среднем%20пользователь,идут%20Viber%2C%20Telegram%20и%20Skype.
6. https://cyberleninka.ru/article/n/poliformatnyy-messendzher-kak-zhanr-2-0-na-primere-messendzhera-mgnovennyh-soobscheniy-telegram/viewer
